<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://unpkg.com/vue@2.7.8/dist/vue.js"></script>
  <script src="product.js"></script>
  <title>Lessons Store App</title>


</head>

<body>
  <div id="app">
    <header>
      <h1 v-text="sitename"></h1>
      <button v-on:click="showCheckout" :disabled="showProduct && cart.length === 0">
        {{ totalLessonsInTheCart }}
        <span class="fa-solid fa-cart-shopping"></span>
        Checkout
      </button>
    </header>

    <div v-if="showProduct">
      <main>
        <!-- Dropdown to select sorting field -->
        <div style="width: 100%; display: flex; justify-content: center; margin-bottom: 20px;">
          <div>
            <label for="sortBy">Sort by:</label>
            <select v-model="sortBy" id="sortBy">
              <option value="subject">Subject</option>
              <option value="location">Location</option>
              <option value="price">Price</option>
              <option value="availableSpace">Available Space</option>
            </select>
          </div>

          <div style="margin-left: 20px;">
            <label for="sortOrder">Order:</label>
            <select v-model="sortOrder" id="sortOrder">
              <option value="ascending">Ascending</option>
              <option value="descending">Descending</option>
            </select>
          </div>
        </div>

        <!-- Display products -->
        <div v-for="product in sortedProducts" :key="product.id" class="product">

          <h1 v-text="'Subject: ' + product.subject"></h1>

          <figure>
            <img v-bind:src="product.image" style="width: 150px; height: auto;">
          </figure>

          <h3 v-text="'Location: ' + product.location"></h3>
          <h3>Price: £{{ product.price.toFixed(2) }}</h3>
          <h3>Spaces: {{ product.availableSpace }}</h3>

          <button v-if="canAddToCart(product)" v-on:click="addLessonsToTheCart(product)">Add to Cart</button>
          <button v-else disabled>Add to Cart</button>

          <span v-if="itemsLeft(product) === 0"> Sold out ! </span>
          <span v-else-if="itemsLeft(product) < 5"> Only {{itemsLeft(product)}} left </span>
          <span v-else> Buy now </span>
        </div>
      </main>
    </div>

    <div v-else class="checkout-page">
      <h1>Welcome to the Checkout page</h1>

      <p>
        <strong>Name: </strong>
        <input type="text" v-model.trim="order.name">
      </p>

      <p>
        <strong>Phone: </strong>
        <input type="text" v-model.trim="order.phone">
      </p>

      <h2>Order Receipt</h2>
      <p><strong>Name:</strong> {{ order.name }}</p>
      <p><strong>Phone:</strong> {{ order.phone }}</p>

      <h3>Your Lessons:</h3>
      <ul>
        <li v-for="(product, index) in cartProducts" :key="product.id">
          {{ product.subject }} (£{{ product.price.toFixed(2) }})
          <button v-on:click="removeFromCart(product, index)">Remove</button>
        </li>
      </ul>

      <!-- Make sure the button is enabled if both name and phone are valid -->
      <button v-on:click="submitCheckoutForm" :disabled="!order.name || !order.phone">Place Order</button>
    </div>
  </div>

  <footer>
    <p>&copy; 2024 Lessons Store</p>
  </footer>

  <script>
    let webstore = new Vue({
      el: "#app",
      data: {
        sitename: "Lessons Store App",
        showProduct: true,
        products: products,
        cart: [],
        order: {
          name: "",
          phone: "",
        },
        sortBy: 'price',   // Default field to sort by
        sortOrder: 'ascending',  // Default sorting order
      },
      methods: {
        showCheckout() {
          this.showProduct = !this.showProduct;  // Toggle between the lessons page and checkout page
        },
        addLessonsToTheCart(product) {
          this.cart.push(product.id);
        },
        removeFromCart(product, index) {
          // Remove the product from the cart by index
          this.cart.splice(index, 1);

          // Increase the available space of the product
          product.availableSpace++;
        },
        submitCheckoutForm() {
          // Validate name
          if (!this.validateName()) {
            alert("The Name must contain letters only!");
            return;
          }

          // Validate phone
          if (!this.validatePhone()) {
            alert("The Phone must contain numbers only!");
            return;
          }

          // If both validations pass, submit the form
          alert("Order Submitted Successfully!");

          // Clear cart after submitting
          this.cart = [];

          // Clear the form fields
          this.order.name = "";
          this.order.phone = "";

          // Return to the lessons page
          this.showProduct = true;
        },
        validateName() {
          const nameRegex = /^[a-zA-Z\s]+$/;
          return nameRegex.test(this.order.name);
        },
        validatePhone() {
          const phoneRegex = /^\d+$/;
          return phoneRegex.test(this.order.phone);
        },
        canAddToCart(product) {
          return product.availableSpace > this.cartCount(product.id);
        },
        cartCount(id) {
          return this.cart.filter(productId => productId === id).length;
        },
        itemsLeft(product) {
          return product.availableSpace - this.cartCount(product.id);
        }
      },
      computed: {
        totalLessonsInTheCart() {
          return this.cart.length || "";
        },
        sortedProducts() {
          const sorted = [...this.products];
          sorted.sort((a, b) => {
            let modifier = this.sortOrder === 'ascending' ? 1 : -1;
            if (this.sortBy === 'price' || this.sortBy === 'availableSpace') {
              return (a[this.sortBy] - b[this.sortBy]) * modifier;
            } else {
              return a[this.sortBy].localeCompare(b[this.sortBy]) * modifier;
            }
          });
          return sorted;
        },
        cartProducts() {
          return this.cart.map(id => this.products.find(product => product.id === id));
        }
      }
    });
  </script>
</body>

</html>
